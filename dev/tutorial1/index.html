<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorials · CommonDataModel.jl</title><meta name="title" content="Tutorials · CommonDataModel.jl"/><meta property="og:title" content="Tutorials · CommonDataModel.jl"/><meta property="twitter:title" content="Tutorials · CommonDataModel.jl"/><meta name="description" content="Documentation for CommonDataModel.jl."/><meta property="og:description" content="Documentation for CommonDataModel.jl."/><meta property="twitter:description" content="Documentation for CommonDataModel.jl."/><meta property="og:url" content="https://juliageo.github.io/CommonDataModel.jl/tutorial1/"/><meta property="twitter:url" content="https://juliageo.github.io/CommonDataModel.jl/tutorial1/"/><link rel="canonical" href="https://juliageo.github.io/CommonDataModel.jl/tutorial1/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CommonDataModel.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Tutorials</a><ul class="internal"><li><a class="tocitem" href="#Select-a-subset-by-values-from-coordinate-variables"><span>Select a subset by values from coordinate variables</span></a></li><li><a class="tocitem" href="#Grouping-and-reducing"><span>Grouping and reducing</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorials</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorials</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaGeo/CommonDataModel.jl/blob/main/docs/src/tutorial1.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Select,-group-and-reduce-data-sets-with-CommonDataModel"><a class="docs-heading-anchor" href="#Select,-group-and-reduce-data-sets-with-CommonDataModel">Select, group and reduce data sets with CommonDataModel</a><a id="Select,-group-and-reduce-data-sets-with-CommonDataModel-1"></a><a class="docs-heading-anchor-permalink" href="#Select,-group-and-reduce-data-sets-with-CommonDataModel" title="Permalink"></a></h1><p>As an example we use the NOAA OISST v2 dataset available at: <a href="https://psl.noaa.gov/thredds/fileServer/Datasets/noaa.oisst.v2.highres/sst.day.mean.2023.nc">https://psl.noaa.gov/thredds/fileServer/Datasets/noaa.oisst.v2.highres/sst.day.mean.2023.nc</a></p><pre><code class="language-julia hljs">using CommonDataModel: @select, @CF_str, @groupby, groupby
using Dates
using Downloads: download
using CairoMakie # use GLMakie for interactive plots
#using GLMakie
using IntervalSets
using NCDatasets
using Statistics</code></pre><p>Some helper functions for plotting with Makie for plotting maps and timeseries.</p><pre><code class="language-julia hljs">function nicemaps(v; timeindex = 1, lon = v[&quot;lon&quot;][:], lat = v[&quot;lat&quot;][:], title = nothing)
    fig, ax, hm = heatmap(lon,lat,v[:,:,timeindex],aspect_ratio = 1/cosd(mean(lat)))
    if !isnothing(title)
        ax.title[] = title
    end
    Colorbar(fig[1,2],hm)
    return fig
end

function nicetimeseries(v::AbstractVector; time = v[&quot;time&quot;][:], title = nothing,
                  timefmt = &quot;yyyy-mm-dd&quot;)
    fig, ax, ln = lines(Dates.value.(time),v[:])
    if !isnothing(title)
        ax.title[] = title
    end
    timeticks = DateTime.(2023,1:2:12,1)
    ax.xticks = Dates.value.(timeticks),Dates.format.(timeticks,timefmt)
    ax.xticklabelrotation = π/4
    return fig
end</code></pre><pre><code class="nohighlight hljs">nicetimeseries (generic function with 1 method)</code></pre><p>Download the data file (unless already downloaded) The dataset contains the variables <code>lon</code> (longitude), <code>lat</code> (latitude), <code>time</code> and <code>sst</code> (sea surface temperature).</p><pre><code class="language-julia hljs">url = &quot;https://psl.noaa.gov/thredds/fileServer/Datasets/noaa.oisst.v2.highres/sst.day.mean.2023.nc&quot;

fname = &quot;sst.day.mean.2023.nc&quot;
if !isfile(fname)
    download(url,fname)
end</code></pre><pre><code class="nohighlight hljs">&quot;sst.day.mean.2023.nc&quot;</code></pre><h2 id="Select-a-subset-by-values-from-coordinate-variables"><a class="docs-heading-anchor" href="#Select-a-subset-by-values-from-coordinate-variables">Select a subset by values from coordinate variables</a><a id="Select-a-subset-by-values-from-coordinate-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Select-a-subset-by-values-from-coordinate-variables" title="Permalink"></a></h2><p>Open the dataset and access the variable <code>sst</code>. Select the domain from 300°E to 360°E and 0°N to 46°N and the closest time instance to the 1 April 2023.</p><pre><code class="language-julia hljs">ds = NCDataset(fname)
ncsst = ds[&quot;sst&quot;]

ncsst2 = @select(ncsst,300 &lt;= lon &lt;= 360 &amp;&amp; 0 &lt;= lat &lt;= 46 &amp;&amp; time ≈ DateTime(2023,4,1))

nicemaps(ncsst2, title = &quot;NA SST&quot;)</code></pre><p><img src="../tutorial1-9.png" alt/></p><p>One can also select a subset by indices and by values. Here we load the first time instance and the domain from 300°E to 360°E and 0°N to 46°N</p><pre><code class="language-julia hljs">ncsst_first = view(ncsst,:,:,1)
ncsst_na = @select(ncsst_first,300 &lt;= lon &lt;= 360 &amp;&amp; 0 &lt;= lat &lt;= 46)
nicemaps(ncsst_na)</code></pre><p><img src="../tutorial1-11.png" alt/></p><p>Select all data from a given month</p><pre><code class="language-julia hljs">ncsst_march = @select(ncsst,Dates.month(time) == 3)
nicemaps(ncsst_march, timeindex = 1, title = &quot;SST 1st March 2023&quot;)</code></pre><p><img src="../tutorial1-13.png" alt/></p><p>Select multiple months using e.g. an interval (from <a href="https://github.com/JuliaMath/IntervalSets.jl">IntervalSets</a>). ∈ can be typed by writing <code>\in</code> directly followed by the TAB key.</p><pre><code class="language-julia hljs">ncsst_march_april = @select(ncsst,Dates.month(time) ∈ 3..4)
nicemaps(ncsst_march_april)</code></pre><p><img src="../tutorial1-15.png" alt/></p><p>Use julia functions to extract data; here the <code>abs</code> function polar regions north of 60°N and south of 60°S</p><pre><code class="language-julia hljs">ncsst_polar = @select(ncsst,abs(lat) &gt; 60)
fig, ax, hm = heatmap(ncsst_polar[:,:,1])
ax.title[] = &quot;regions north of 60°N and south of 60°S ($(ncsst_polar[:time][1]))&quot;
Colorbar(fig[1,2],hm)</code></pre><pre><code class="nohighlight hljs">Makie.Colorbar()</code></pre><p>Extract the time series of the closest point to a given point</p><pre><code class="language-julia hljs">ncsst_timeseries = @select(ncsst,lon ≈ 330 &amp;&amp; lat ≈ 38)
lon = ncsst_timeseries[&quot;lon&quot;][:]
lat = ncsst_timeseries[&quot;lat&quot;][:]
nicetimeseries(ncsst_timeseries, title = &quot;SST at $(lon) °E and $(lat) °N&quot;)</code></pre><p><img src="../tutorial1-19.png" alt/></p><p>Extract the time series of the closest point with a specified tolerance If there is no data nearby an empty array is returned</p><pre><code class="language-julia hljs">ncsst_outside = @select(ncsst,lon ≈ 330 &amp;&amp; lat ≈ 93 ± 0.1)
isempty(ncsst_outside)
size(ncsst_outside)</code></pre><pre><code class="nohighlight hljs">(0, 365)</code></pre><p>Rather than selecting SST based on coordinates, we can also do the reverse: select the longitude based on SST. Find the longitudes where the SST exceeds 30 at the equator. <code>sst</code> can contain missing values (e.g. on land). <code>coalesce</code> is necessary here to replace the missing values by false in the boolean expression.</p><pre><code class="language-julia hljs">ds_equator = @select(ds,lat ≈ 0 &amp;&amp; time ≈ DateTime(2023,1,1))
lon_equator = @select(ds_equator,coalesce(sst &gt; 30,false))[&quot;lon&quot;]</code></pre><pre><code class="nohighlight hljs">lon (54)
  Datatype:    Float32
  Dimensions:  lon
  Attributes:
   long_name            = Longitude
   standard_name        = longitude
   units                = degrees_east
   actual_range         = Float32[0.125, 359.875]
   axis                 = X
</code></pre><p>The first 3 longitude where SST exceeds 30°C at the equator for 2023-01-01</p><pre><code class="language-julia hljs">lon_equator[1:3]</code></pre><pre><code class="nohighlight hljs">3-element Vector{Float32}:
 124.125
 124.375
 124.625</code></pre><h2 id="Grouping-and-reducing"><a class="docs-heading-anchor" href="#Grouping-and-reducing">Grouping and reducing</a><a id="Grouping-and-reducing-1"></a><a class="docs-heading-anchor-permalink" href="#Grouping-and-reducing" title="Permalink"></a></h2><p>With the function <a href="../#CommonDataModel.groupby-Union{Tuple{TF}, Tuple{CommonDataModel.AbstractVariable, Pair{&lt;:Union{AbstractString, Symbol}, TF}}} where TF"><code>groupby</code></a> and macro <a href="../#CommonDataModel.@groupby-Tuple{Any, Any}"><code>@groupby</code></a> we can group the variable by a given criteria. For each group, we can then apply a reducting function (<code>mean</code>, <code>sum</code>, <code>std</code>, ...).</p><p>For example group the SST by month and average per month:</p><pre><code class="language-julia hljs">sst_mean = mean(@groupby(ncsst,Dates.Month(time)))</code></pre><pre><code class="nohighlight hljs">sst (1440 × 720 × 12)
  Datatype:    Union{Missing, Float32}
  Dimensions:  lon × lat × time
  Attributes:
   long_name            = Daily Sea Surface Temperature
   units                = degC
   valid_range          = Float32[-3.0, 45.0]
   missing_value        = -9.96921e36
   precision            = 2.0
   dataset              = NOAA High-resolution Blended Analysis
   var_desc             = Sea Surface Temperature
   level_desc           = Surface
   statistic            = Mean
   parent_stat          = Individual Observations
   actual_range         = Float32[-1.8, 36.94]
</code></pre><p>Instead of using the macro one can also use the function <code>groupby</code>:</p><pre><code class="language-julia hljs">sst_mean = mean(groupby(ncsst,:time =&gt; Dates.Month))
nicemaps(sst_mean, timeindex = 1, title = &quot;Mean January SST&quot;)</code></pre><p><img src="../tutorial1-30.png" alt/></p><p>Use custom julia function for grouping: The <a href="https://en.wikipedia.org/w/index.php?title=Atlantic_hurricane_season&amp;oldid=1189144955">Atlantic hurricane season</a> is the period in a year, from June 1 through November 30, when tropical or subtropical cyclones are most likely to form in the North Atlantic Ocean. The data will be grouped into two cases: <code>false</code> (time outside the Atlantic hurricane season) and <code>true</code> (time is within the Atlantic hurricane season). We plot only the 2nd group.</p><pre><code class="language-julia hljs">sst_na = @select(ncsst,300 &lt;= lon &lt;= 360 &amp;&amp; 0 &lt;= lat &lt;= 46)
sst_hs = mean(@groupby(sst_na,DateTime(year(time),6,1) &lt;= time &lt;= DateTime(year(time),11,30)))

nicemaps(sst_hs,timeindex = 2, title = &quot;mean SST during the Atlantic hurricane season&quot;)</code></pre><p><img src="../tutorial1-32.png" alt/></p><p>Use a user defined function <code>is_atlantic_hurricane_season</code> without the <code>@groupby</code> macro:</p><pre><code class="language-julia hljs">is_atlantic_hurricane_season(time) =
    DateTime(year(time),6,1) &lt;= time &lt;= DateTime(year(time),11,30)

sst_std_hs = std(groupby(sst_na,:time =&gt; is_atlantic_hurricane_season));

nicemaps(sst_std_hs,timeindex = 2, title = &quot;std SST during the Atlantic hurricane season&quot;)</code></pre><p><img src="../tutorial1-34.png" alt/></p><p>Use a custom aggregation function to estimate the probability that the temperature exceeds 26°C during the Atlantic hurricane season</p><pre><code class="language-julia hljs">using CommonDataModel: GroupedVariable
prob_hot(x; dims=:) = mean(coalesce.(x .&gt; 26,false); dims=dims)
prob_hot(gv::GroupedVariable) = reduce(prob_hot,gv)

is_atlantic_hurricane_season(time) =
    DateTime(year(time),6,1) &lt;= time &lt;= DateTime(year(time),11,30)

sst_my_mean = prob_hot(groupby(ncsst,:time =&gt; is_atlantic_hurricane_season));

nicemaps(sst_my_mean,timeindex=2, title = &quot;probability(temp. &gt; 26°C) during Atlantic hurricane season&quot;)</code></pre><p><img src="../tutorial1-36.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a>, <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a></p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 21 January 2025 09:06">Tuesday 21 January 2025</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
